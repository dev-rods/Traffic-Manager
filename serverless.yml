service: traffic-manager-infra

frameworkVersion: '3'

custom:
  stage: ${opt:stage, self:provider.stage}
  resourcePrefix: ${self:service}-${self:custom.stage}
  

provider:
  name: aws
  runtime: python3.9
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-east-1'}
  environment:
    STAGE: ${self:custom.stage}
    OPENAI_API_KEY: ${ssm:/traffic/openai-key~true}
    GOOGLE_ADS_CLIENT_ID: ${ssm:/traffic/google-ads-client-id~true}
    GOOGLE_ADS_CLIENT_SECRET: ${ssm:/traffic/google-ads-client-secret~true}
    GOOGLE_ADS_REFRESH_TOKEN: ${ssm:/traffic/google-ads-refresh-token~true}
    GOOGLE_ADS_DEVELOPER_TOKEN: ${ssm:/traffic/google-ads-developer-token~true}
    CAMPAIGN_TEMPLATES_TABLE: ${self:resources.Resources.CampaignTemplatesTable.Properties.TableName}
    EXECUTION_HISTORY_TABLE: ${self:resources.Resources.ExecutionHistoryTable.Properties.TableName}
    CAMPAIGN_METADATA_TABLE: ${self:resources.Resources.CampaignMetadataTable.Properties.TableName}
    BASE_FUNCTION_NAME: ${self:service}-${self:custom.stage}-
    BASE_STATE_MACHINE_NAME: ${self:service}-${self:custom.stage}-statemachine-
    BASE_ROLE_ARN: arn:aws:iam::${aws:accountId}:role/${self:service}-${self:custom.stage}-

functions:
  - ${file(sls/functions/campaign/interface.yml)}
  - ${file(sls/functions/templates/interface.yml)}
  - ${file(sls/functions/metrics/interface.yml)}
  - ${file(sls/functions/openai/interface.yml)}
  - ${file(sls/functions/parser/interface.yml)}
  - ${file(sls/functions/googleads/interface.yml)}

resources:
  Resources:
    # Step Functions
    - ${file(sls/resources/stepfunctions/campaign-optimization-flow.yml)}
    
    # IAM Roles
    - ${file(sls/resources/iam/state-machine-role.yml)}
    
    # Tabelas DynamoDB - uma tabela por arquivo
    - ${file(sls/resources/dynamodb/campaign-templates-table.yml)}
    - ${file(sls/resources/dynamodb/execution-history-table.yml)}
    - ${file(sls/resources/dynamodb/campaign-metadata-table.yml)}